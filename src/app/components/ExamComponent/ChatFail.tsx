import React from 'react';
import { api } from '~/trpc/react';
import { useExamStore } from '@/store/examStore';

interface ChatFailProps {
  onRetry: () => void;
  examId: string;
}

const ChatFail = ({ onRetry, examId }: ChatFailProps) => {
  const utils = api.useUtils();
  const { updateCompletionStatus } = useExamStore();

  const restartExamMutation = api.examAi.restartExam.useMutation({
    onSuccess: () => {
      // Reset completion status in the store
      updateCompletionStatus(false, false);

      // Reset the chat history query to trigger a refetch
      utils.examAi.getChatHistory.reset({ examId });

      // Switch back to chat mode
      onRetry();
    },
  });

  const handleRestartExam = () => {
    restartExamMutation.mutate({ examId });
  };

  return (
    <>
      <div className="mt-auto mb-auto flex flex-col items-center gap-12 p-8">
        <div className="flex flex-col items-center gap-10">
          <svg
            width="120"
            height="120"
            viewBox="0 0 120 120"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            className="h-30 w-30"
          >
            <mask id="path-1-inside-1_4430_41842" fill="white">
              <path d="M120 60C120 93.1371 93.1371 120 60 120C26.8629 120 0 93.1371 0 60C0 26.8629 26.8629 0 60 0C93.1371 0 120 26.8629 120 60ZM1.8 60C1.8 92.143 27.857 118.2 60 118.2C92.143 118.2 118.2 92.143 118.2 60C118.2 27.857 92.143 1.8 60 1.8C27.857 1.8 1.8 27.857 1.8 60Z" />
            </mask>
            <path
              d="M120 60C120 93.1371 93.1371 120 60 120C26.8629 120 0 93.1371 0 60C0 26.8629 26.8629 0 60 0C93.1371 0 120 26.8629 120 60ZM1.8 60C1.8 92.143 27.857 118.2 60 118.2C92.143 118.2 118.2 92.143 118.2 60C118.2 27.857 92.143 1.8 60 1.8C27.857 1.8 1.8 27.857 1.8 60Z"
              stroke="url(#paint0_linear_4430_41842)"
              stroke-width="1.83206"
              mask="url(#path-1-inside-1_4430_41842)"
            />
            <path
              d="M66.6562 47.6484C70.7042 47.6485 73.996 50.946 73.9961 55.0332C73.9961 56.4999 73.7918 57.8675 73.4297 59.1475L73.2646 59.6904L73.2627 59.6973C72.1493 63.2206 69.8639 66.0694 67.3857 68.1992C65.0584 70.1993 62.6111 71.5218 60.9297 72.1504L60.6035 72.2666L60.5938 72.2705C60.4791 72.311 60.2621 72.3486 59.9961 72.3486C59.7301 72.3486 59.5131 72.311 59.3984 72.2705H59.3994L59.3887 72.2666L59.0625 72.1504C57.3811 71.5218 54.9338 70.1993 52.6064 68.1992C50.2057 66.1359 47.9855 63.3979 46.8369 60.0254L46.7295 59.6973L46.7275 59.6904L46.5625 59.1475C46.2004 57.8675 45.9961 56.4999 45.9961 55.0332C45.9962 50.946 49.288 47.6485 53.3359 47.6484C55.7211 47.6484 57.8602 48.8082 59.1953 50.5928L59.9961 51.6631L60.7969 50.5928C62.132 48.8082 64.2711 47.6484 66.6562 47.6484Z"
              stroke="url(#paint1_linear_4430_41842)"
              stroke-width="2"
            />
            <defs>
              <linearGradient
                id="paint0_linear_4430_41842"
                x1="-14.6939"
                y1="120"
                x2="123.281"
                y2="140.012"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#FF20A2" />
                <stop offset="1" stop-color="#FF5B20" />
              </linearGradient>
              <linearGradient
                id="paint1_linear_4430_41842"
                x1="41.3226"
                y1="73.3484"
                x2="75.6308"
                y2="78.9396"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#FF20A2" />
                <stop offset="1" stop-color="#FF5B20" />
              </linearGradient>
            </defs>
          </svg>

          <div className="flex flex-col items-center gap-8">
            <div className="flex flex-col items-center gap-5">
              <span className="text-2xl">«Жизни» исчерпаны!</span>
              <span className="text-secondary text-center text-sm">
                Превышен допустимый лимит ошибок, требуется повторная сдача
                зачета. Рекомендуется повторно ознакомиться с теоретическим и
                практическим материалом по теме.
              </span>
            </div>
            <button
              onClick={handleRestartExam}
              disabled={restartExamMutation.isPending}
              className="border-primary hover:bg-primary flex cursor-pointer flex-row rounded-[5.2083vw] border px-10 py-3.5 text-sm"
            >
              {restartExamMutation.isPending
                ? 'Перезапуск...'
                : 'Повторить зачет'}
              {!restartExamMutation.isPending && (
                <svg
                  width="21"
                  height="20"
                  viewBox="0 0 21 20"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  className="h-5 w-5"
                >
                  <path
                    d="M14.7305 4.43173C15.0107 4.16285 15.4458 4.15427 15.7354 4.40048L15.7911 4.45321L20.4063 9.26181C20.6848 9.55201 20.6848 10.0107 20.4063 10.3009L15.7911 15.1095C15.5042 15.4083 15.0294 15.4178 14.7305 15.1309C14.432 14.8441 14.4223 14.3691 14.709 14.0704L18.8252 9.78134L14.709 5.49228L14.6583 5.43368C14.4245 5.1343 14.4506 4.7005 14.7305 4.43173Z"
                    fill="#F2F2F2"
                  />
                </svg>
              )}
            </button>
          </div>
        </div>
      </div>
      <div className="flex w-full flex-row items-center justify-center gap-2 bg-[#14171C] py-2.25">
        <svg
          width="74"
          height="14"
          viewBox="0 0 74 14"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          className="h-3.5 w-18.5"
        >
          <g clip-path="url(#clip0_4430_43329)">
            <rect width="14" height="14" rx="2.8" fill="#195AF4" />
            <path
              d="M6.20801 8.30762L10.6309 11.21V9.65625L8.60059 8.38281L8.4834 8.30957L8.59961 8.23535L10.6309 6.93945V5.34277L6.20801 8.30762Z"
              fill="#F2F2F2"
              stroke="#195AF4"
              stroke-width="0.175"
            />
            <path
              d="M7.79199 5.75293L3.36914 8.65527V7.10156L5.39941 5.82812L5.5166 5.75488L5.40039 5.68066L3.36914 4.38477V2.78809L7.79199 5.75293Z"
              fill="#F2F2F2"
              stroke="#195AF4"
              stroke-width="0.175"
            />
          </g>
          <path
            d="M21.6401 9.9469H23.8129C24.8769 9.9469 25.4705 9.5213 25.4705 8.7261C25.4705 7.9309 24.8881 7.4717 23.8129 7.4717H21.6401V9.9469ZM21.6401 6.4525H23.4657C24.5969 6.4525 25.2129 6.0269 25.2129 5.2877C25.2129 4.5037 24.6417 4.1341 23.4657 4.1341H21.6401V6.4525ZM20.3633 11.0445V3.0365H23.5665C25.5937 3.0365 26.5569 3.6973 26.5569 5.1869C26.5569 6.1165 25.9633 6.7661 24.9441 6.9005C26.0529 7.0573 26.8033 7.7181 26.8033 8.8381C26.8033 10.3053 25.8065 11.0445 23.9137 11.0445H20.3633Z"
            fill="#F2F2F2"
          />
          <path
            d="M27.7495 11.0445V2.8125H28.9927V11.0445H27.7495Z"
            fill="#F2F2F2"
          />
          <path
            d="M31.281 8.0093C31.281 9.2749 31.9418 10.1149 33.0506 10.1149C34.1594 10.1149 34.809 9.2749 34.809 8.0093C34.809 6.7549 34.1594 5.9149 33.0506 5.9149C31.9418 5.9149 31.281 6.7549 31.281 8.0093ZM30.0042 8.0093C30.0042 6.1277 31.2138 4.8397 33.0506 4.8397C34.8874 4.8397 36.097 6.1277 36.097 8.0093C36.097 9.9021 34.8874 11.1901 33.0506 11.1901C31.2138 11.1901 30.0042 9.9021 30.0042 8.0093Z"
            fill="#F2F2F2"
          />
          <path
            d="M36.9329 8.0093C36.9329 6.1165 38.1313 4.8397 39.9681 4.8397C41.5249 4.8397 42.6225 5.7581 42.8913 7.1693H41.5809C41.3793 6.3965 40.8193 5.9149 39.9793 5.9149C38.8593 5.9149 38.2097 6.7437 38.2097 8.0093C38.2097 9.2749 38.8593 10.1149 39.9793 10.1149C40.8641 10.1149 41.4353 9.5773 41.6033 8.7373H42.9137C42.6785 10.2269 41.5585 11.1901 39.9681 11.1901C38.1313 11.1901 36.9329 9.9021 36.9329 8.0093Z"
            fill="#F2F2F2"
          />
          <path
            d="M43.8655 11.0445V2.8125H45.1087V7.5725L48.0095 4.9853H49.6447L46.9567 7.3933L49.7455 11.0445H48.2335L46.0719 8.1549L45.1087 9.0285V11.0445H43.8655Z"
            fill="#F2F2F2"
          />
          <path
            d="M50.4239 11.0445V3.0365H55.8223V4.1565H51.7007V6.5869H55.6319V7.6845H51.7007V11.0445H50.4239Z"
            fill="#F2F2F2"
          />
          <path
            d="M56.8375 11.0445V4.9853H58.0807V11.0445H56.8375ZM56.8039 4.2125V2.8797H58.1255V4.2125H56.8039Z"
            fill="#F2F2F2"
          />
          <path
            d="M59.3031 11.0445V4.9853H60.4567L60.5015 6.2285C60.7367 5.3661 61.2743 4.9853 62.0807 4.9853H62.7527V6.2845H62.0247C61.0391 6.2845 60.5687 6.8109 60.5687 7.7853V11.0445H59.3031Z"
            fill="#F2F2F2"
          />
          <path
            d="M63.1615 9.0397H64.4383C64.4943 9.7453 64.9983 10.1821 65.9951 10.1821C66.7231 10.1821 67.3055 9.9357 67.3055 9.3645C67.3055 8.7373 66.6223 8.6253 65.6591 8.4797C64.5839 8.3005 63.3071 8.0541 63.3071 6.7213C63.3071 5.6013 64.2255 4.8397 65.7935 4.8397C67.4511 4.8397 68.3583 5.7133 68.4815 6.9117H67.2159C67.1375 6.2509 66.5999 5.8477 65.7711 5.8477C64.9983 5.8477 64.5951 6.1949 64.5951 6.6205C64.5951 7.2253 65.3231 7.3597 66.1743 7.4941C67.3391 7.6957 68.5935 7.9309 68.5935 9.2973C68.5935 10.5741 67.4847 11.1901 65.9951 11.1901C64.2255 11.1901 63.2287 10.3165 63.1615 9.0397Z"
            fill="#F2F2F2"
          />
          <path
            d="M69.9174 8.9501V6.0605H68.9542V4.9853H69.9174V3.4509H71.183V4.9853H73.3222V6.0605H71.183V8.9389C71.183 9.7789 71.5302 10.0701 72.3926 10.0701C72.639 10.0701 72.9862 10.0477 73.3222 9.9693V11.0557C72.8406 11.1341 72.4262 11.1789 72.0678 11.1789C70.6118 11.1789 69.9174 10.4845 69.9174 8.9501Z"
            fill="#F2F2F2"
          />
          <defs>
            <clipPath id="clip0_4430_43329">
              <rect width="14" height="14" fill="white" />
            </clipPath>
          </defs>
        </svg>
      </div>
    </>
  );
};

export default ChatFail;
